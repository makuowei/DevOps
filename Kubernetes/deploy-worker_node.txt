#!/bin/sh

;
; Reference: https://www.tecmint.com/install-a-kubernetes-cluster-on-centos-8/

; Step 1: Prep Firewall, SELINUX

; list uuid and confirm master and nodes are haveing differnet value in virtualized env
cat /sys/class/dmi/id/product_uuid		; list uuid
ip link									; show MAC address

; Disable SElinux
setenforce 0
sed -i --follow-symlinks 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux


; Configure Firewall ports 
firewall-cmd --permanent --add-port=6443/tcp			;Kubernetes API Server
firewall-cmd --permanent --add-port=2379-2380/tcp		;etcd server client
firewall-cmd --permanent --add-port=10250/tcp			;Kubelet API
firewall-cmd --permanent --add-port=10251/tcp			;Kube-scheduler
firewall-cmd --permanent --add-port=10252/tcp			;Kube-controller-manager
firewall-cmd --permanent --add-port=10255/tcp
firewall-cmd -â€“reload
modprobe br_netfilter
echo '1' > /proc/sys/net/bridge/bridge-nf-call-iptables

; Step 2: Install Docker-CE on CentOS 8
dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
dnf install https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm -y
dnf install docker-ce -y
systemctl enable docker
systemctl start docker

; Step 3: Install Kubernetes (Kubeadm) on CentOS 8
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

dnf install kubeadm -y
systemctl enable kubelet
systemctl start kubelet

; Step 4: Join Worker Node to Kubernetes Cluster
;   Need to replace with your token when init the master node

swapoff -a				;Disable Swap
kubeadm join 172.16.83.10:6443 --token kmffnm.ecpizzjeqohtn6ap --discovery-token-ca-cert-hash sha256:38d2a37f9a0698ffbb8f0c9725adab96776242af8bd566062eca352865ce81ce

; **** On Master node, issue the command to verify master nodes and worker nodes are in Ready state
kubectl get nodes	;should list master node with Status:Ready stat
kubectl get pods --all-namespaces --watch



